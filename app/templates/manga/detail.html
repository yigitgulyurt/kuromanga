{% extends "base.html" %}
{% block title %}{{ manga.title }}{% endblock %}
{% block content %}
<section class="section">
  <h2>{{ manga.title }}</h2>
  {% if manga.description %}
    <p class="card-desc">{{ manga.description }}</p>
  {% endif %}
  {% if last_read_chapter %}
    <p>Son okuduğunuz bölüm: <a class="btn btn-outline btn-sm" href="{{ url_for('manga.chapter_read', manga_id=manga.id, chapter_id=last_read_chapter.id) }}">Bölüm {{ last_read_chapter.number }}</a></p>
  {% endif %}
  <div class="actions my-16">
    <form method="POST" action="{{ url_for('user_content.toggle_favorite', manga_id=manga.id) }}" class="inline">
      <button class="btn btn-primary {{ 'on' if is_favorite else '' }}" type="submit">
        {{ 'Favorilerden Çıkar' if is_favorite else 'Favorilere Ekle' }}
      </button>
    </form>
    <form method="POST" action="{{ url_for('user_content.toggle_to_read', manga_id=manga.id) }}" class="inline">
      <button class="btn btn-secondary {{ 'on' if is_to_read else '' }}" type="submit">
        {{ 'Okunacaklardan Çıkar' if is_to_read else 'Okunacaklara Ekle' }}
      </button>
    </form>
  </div>
</section>

<section class="section mt-16">
  <h3>Bölümler</h3>
  <ul class="list chapter-links">
    {% for chapter in chapters %}
      <li>
        <a class="btn btn-outline btn-sm" href="{{ url_for('manga.chapter_read', manga_id=manga.id, chapter_id=chapter.id) }}">
          Bölüm {{ chapter.number }}{% if chapter.title %}{% endif %}
        </a>
      </li>
    {% else %}
      <li>Bu manga için henüz bölüm yok.</li>
    {% endfor %}
  </ul>
</section>

<section class="section mt-16">
  <h3>Yorumlar</h3>
  <div class="comment-form">
    <form method="POST" action="{{ url_for('user_content.add_comment', manga_id=manga.id) }}" class="form">
      <textarea name="content" placeholder="Yorum yaz..." required></textarea>
      <button type="submit" class="btn btn-outline">Yorum Gönder</button>
    </form>
  </div>
  <div class="comment-list mt-10">
    {% for c in comments %}
      <div class="comment" id="comment-{{ c.id }}">
        <div class="comment-header">
          <div class="comment-user">
            <div class="comment-avatar">
              {{ (c.user.username or 'U')[0].upper() }}
            </div>
            <div class="comment-info">
              <div class="comment-username">{{ c.user.username }}</div>
              <div class="comment-meta">{{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
            </div>
          </div>
          {% if current_user and c.user_id == current_user.id %}
            <div class="comment-header-actions">
              <button class="btn-delete" onclick="deleteComment({{ c.id }})">Sil</button>
            </div>
          {% endif %}
        </div>
        <div class="comment-body">{{ c.content }}</div>
      </div>
    {% else %}
      <p>Bu manga için yorum bulunamadı.</p>
    {% endfor %}
  </div>
</section>

<script>
function deleteComment(commentId) {
    if (!confirm('Bu yorumu silmek istediğinize emin misiniz?')) return;
    
    fetch(`/comment/${commentId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            const el = document.getElementById(`comment-${commentId}`);
            if (el) {
                el.style.opacity = '0';
                el.style.transform = 'translateY(10px)';
                setTimeout(() => el.remove(), 300);
            }
        } else {
            alert('Yorum silinirken bir hata oluştu.');
        }
    })
    .catch(err => {
        console.error(err);
        alert('Bir ağ hatası oluştu.');
    });
}
</script>
{% endblock %}
