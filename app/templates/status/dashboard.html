{% extends "base.html" %}
{% block title %}Sistem Durum Paneli{% endblock %}
{% block content %}
<div class="container py-8">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold">Sistem Durumu</h1>
            <p class="text-muted mt-2">Veritabanı ve servislerin anlık çalışma durumu.</p>
        </div>
        <button id="trigger-index" class="btn btn-primary">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6m12-4a9 9 0 0 1-15 6.7L3 16"/></svg>
            Depolamayı İndeksle
        </button>
    </div>

    <div id="loading" class="status-card text-center py-12">
        <div class="flex justify-center mb-4">
            <svg class="animate-spin" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        </div>
        <p class="text-lg">Sistem durumu yükleniyor...</p>
    </div>

    <div id="dashboard" style="display:none">
        <!-- Veritabanı İstatistikleri -->
        <h2 class="text-xl font-bold mb-6">Veritabanı İstatistikleri</h2>
        <div class="status-grid">
            <div class="status-card">
                <h3>Toplam Manga</h3>
                <div class="value" id="db-mangas">-</div>
                <div class="label">Kayıtlı manga serisi</div>
            </div>
            <div class="status-card">
                <h3>Toplam Bölüm</h3>
                <div class="value" id="db-chapters">-</div>
                <div class="label">Yüklenen toplam bölüm</div>
            </div>
            <div class="status-card">
                <h3>Toplam Sayfa</h3>
                <div class="value" id="db-pages">-</div>
                <div class="label">Okunabilir manga sayfası</div>
            </div>
        </div>

        <!-- Servis Durumları -->
        <h2 class="text-xl font-bold mb-6">Servis Durumları</h2>
        <div class="status-grid">
            <div class="status-card">
                <h3>Scraper (Bot)</h3>
                <div class="flex items-center gap-3 mt-2">
                    <span id="run-scraper-status" class="status-badge">Yükleniyor...</span>
                </div>
                <div class="label mt-4" id="run-scraper-time">Son çalışma: -</div>
                <div class="text-xs text-muted mt-1" id="run-scraper-stats"></div>
            </div>
            <div class="status-card">
                <h3>Indexer (Dizinleyici)</h3>
                <div class="flex items-center gap-3 mt-2">
                    <span id="run-indexer-status" class="status-badge">Yükleniyor...</span>
                </div>
                <div class="label mt-4" id="run-indexer-time">Son çalışma: -</div>
                <div class="text-xs text-muted mt-1" id="run-indexer-stats"></div>
            </div>
        </div>

        <!-- Son Çalışmalar -->
        <h2 class="text-xl font-bold mb-6">Son Çalışmalar</h2>
        <div class="overflow-x-auto">
            <table class="runs-table">
                <thead>
                    <tr>
                        <th>Bileşen</th>
                        <th>Durum</th>
                        <th>Manga / İşlem</th>
                        <th>Başlangıç Zamanı</th>
                    </tr>
                </thead>
                <tbody id="recent-runs-list">
                    <!-- Dinamik olarak dolacak -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
.animate-spin {
    animation: spin 1s linear infinite;
}
.overflow-x-auto {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
</style>

<script>
    document.getElementById('trigger-index').addEventListener('click', function() {
        const btn = this;
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> İndeksleniyor...';
        
        fetch('{{ url_for("indexer.index_storage_route") }}', { method: 'GET' })
            .then(resp => resp.json())
            .then(data => {
                btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> Tamamlandı';
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            })
            .catch(err => {
                alert('Hata: ' + err);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            });
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Verileri getir
        fetch('/status/data')
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

                if (data.db_stats) {
                    document.getElementById('db-mangas').textContent = data.db_stats.mangas.toLocaleString();
                    document.getElementById('db-chapters').textContent = data.db_stats.chapters.toLocaleString();
                    document.getElementById('db-pages').textContent = data.db_stats.pages.toLocaleString();
                }
            })
            .catch(err => {
                document.getElementById('loading').innerHTML = `<p style="color:var(--danger)">Veriler yüklenirken hata oluştu: ${err}</p>`;
            });
        
        // Çalışma geçmişini getir
        fetch('/status/runs')
            .then(response => response.json())
            .then(data => {
                function updateRunCard(prefix, runData) {
                    const statusEl = document.getElementById(prefix + '-status');
                    const timeEl = document.getElementById(prefix + '-time');
                    const statsEl = document.getElementById(prefix + '-stats');
                    
                    if (!runData) {
                        statusEl.textContent = 'HİÇ ÇALIŞMADI';
                        statusEl.className = 'status-badge info';
                        return;
                    }
                    
                    statusEl.textContent = runData.status === 'success' ? 'AKTİF' : (runData.status === 'running' ? 'ÇALIŞIYOR' : 'HATA');
                    statusEl.className = `status-badge ${runData.status === 'success' ? 'success' : (runData.status === 'running' ? 'warning' : 'danger')}`;
                    
                    const date = new Date(runData.started_at);
                    timeEl.textContent = 'Son çalışma: ' + date.toLocaleString();
                    
                    if (runData.error) {
                        statsEl.textContent = runData.error;
                        statsEl.className = 'text-xs text-danger mt-1';
                    } else if (runData.stats) {
                        statsEl.textContent = `Manga: ${runData.stats.manga}, Bölüm: ${runData.stats.chapters}, Sayfa: ${runData.stats.pages}`;
                    }
                }
                
                updateRunCard('run-scraper', data.last_scraper_run);
                updateRunCard('run-indexer', data.last_indexer_run);
                
                const listEl = document.getElementById('recent-runs-list');
                const runs = Array.isArray(data.recent_runs) ? data.recent_runs : [];
                listEl.innerHTML = '';
                
                runs.forEach(function(run) {
                    const status = (run.status || '').toLowerCase();
                    const badgeClass = status === 'success' ? 'success' : (status === 'running' ? 'warning' : 'danger');
                    const statusText = status === 'success' ? 'BAŞARILI' : (status === 'running' ? 'ÇALIŞIYOR' : 'HATA');
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="font-medium text-primary">${run.component || '-'}</span> <span class="text-xs text-muted">(${run.type || '-'})</span></td>
                        <td><span class="status-badge ${badgeClass}">${statusText}</span></td>
                        <td>${run.manga_name || run.manga_slug || '-'}</td>
                        <td class="text-muted">${run.started_at ? new Date(run.started_at).toLocaleString() : '-'}</td>
                    `;
                    listEl.appendChild(row);
                });
            })
            .catch(console.error);
    });
</script>
{% endblock %}
